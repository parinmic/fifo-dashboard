<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>FIFO Real Time Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #F4F7FE;
            width: 100%;
            height: 100%;
            overflow: hidden;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 15px;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: auto;
        }

        .main-layout {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .left-panel {
            flex-shrink: 0;
        }

        .right-panel {
            flex: 1;
            max-width: 500px;
        }

        .mas-sku-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(67, 24, 255, 0.08);
        }

        .mas-sku-title {
            font-size: 1em;
            font-weight: 600;
            color: #2B3674;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mas-sku-table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .mas-sku-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
        }

        .mas-sku-table th {
            background: linear-gradient(135deg, #4318FF 0%, #868CFF 100%);
            color: white;
            padding: 10px 12px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .mas-sku-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #E9EDF7;
            color: #2B3674;
        }

        .mas-sku-table tr:hover {
            background: #F4F7FE;
        }

        .mas-sku-table tr:nth-child(even) {
            background: #FAFCFE;
        }

        .mas-sku-table tr:nth-child(even):hover {
            background: #F4F7FE;
        }

        .sku-count {
            font-size: 0.75em;
            color: #A3AED0;
            font-weight: normal;
        }

        .results-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(67, 24, 255, 0.08);
            margin-top: 25px;
            overflow: visible;
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .results-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #2B3674;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .results-table-container {
            max-height: calc(100vh - 180px);
            overflow: auto;
            border-radius: 12px;
            overscroll-behavior: none;
        }

        .results-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.8em;
            background: white;
            table-layout: fixed;
        }

        .results-table th {
            background: #7551FF;
            color: white;
            padding: 12px 10px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 2;
            white-space: nowrap;
            font-weight: 600;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            -webkit-box-shadow: none !important;
        }

        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
        .results-table th:first-child,
        .results-table td:nth-child(1) { width: 150px; min-width: 150px; max-width: 150px; } /* ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - fixed width for sticky */
        .results-table tbody td:nth-child(2),
        .results-table tbody td:nth-child(3) { width: 55px; min-width: 55px; } /* ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á, ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß */
        .results-table tbody td:nth-child(4),
        .results-table tbody td:nth-child(5),
        .results-table tbody td:nth-child(6),
        .results-table tbody td:nth-child(7),
        .results-table tbody td:nth-child(8),
        .results-table tbody td:nth-child(9) { width: 50px; min-width: 50px; max-width: 50px; } /* STOCK & FIFO */
        .results-table tbody td:nth-child(10) { } /* ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ - auto */
        .results-table tbody td:nth-child(11) { width: 70px; min-width: 70px; } /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */

        .results-table thead tr:first-child th {
            background: linear-gradient(135deg, #4318FF 0%, #868CFF 100%);
            height: 42px;
        }

        .results-table thead tr:first-child th[rowspan="2"] {
            background: linear-gradient(180deg, #4318FF 0%, #7551FF 50%, #7551FF 100%);
            height: 84px;
            vertical-align: middle;
        }

        .results-table thead tr:nth-child(2) th {
            top: 42px;
            z-index: 1;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            height: 42px;
        }

        .results-table thead tr:nth-child(2) {
            background: #7551FF;
        }

        .results-table th.sub-header {
            background: #7551FF;
            font-size: 0.9em;
            font-weight: 500;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            margin: 0;
            padding: 12px 10px;
        }

        /* ‡∏´‡∏±‡∏ß‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö FIFO */
        .results-table th.fifo-header {
            background: linear-gradient(135deg, #DC2626 0%, #EF4444 100%) !important;
        }
        .results-table th.sub-header.fifo-sub {
            background: #DC2626 !important;
        }

        .results-table thead {
            border-collapse: collapse;
            border-spacing: 0;
        }

        .results-table thead tr {
            border: none !important;
            border-spacing: 0;
        }

        .results-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #E9EDF7;
            text-align: center;
            color: #2B3674;
        }

        .results-table td.left {
            text-align: left;
            font-weight: 500;
        }

        /* Freeze first column (‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤) */
        .results-table th:first-child,
        .results-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 3;
            background: inherit;
        }

        .results-table th:first-child {
            background: linear-gradient(180deg, #4318FF 0%, #7551FF 50%, #7551FF 100%);
            z-index: 4;
        }

        .results-table td:first-child {
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .results-table tr:nth-child(even) td:first-child {
            background: #FAFCFE;
        }

        .results-table tr:hover td:first-child {
            background: #F4F7FE;
        }

        .results-table tr:hover {
            background: #F4F7FE;
        }

        .results-table tr:nth-child(even) {
            background: #FAFCFE;
        }

        .results-table tr:nth-child(even):hover {
            background: #F4F7FE;
        }

        .no-data {
            color: #A3AED0;
            font-style: italic;
            text-align: center;
            padding: 30px;
        }

        .status-pending {
            background: #FEF3C7 !important;
            color: #92400E;
            font-weight: 600;
        }

        .status-fifo {
            background: #FEE2E2 !important;
            color: #991B1B;
            font-weight: 600;
        }

        .fifo-alert {
            background: #FEE2E2 !important;
            color: #991B1B;
            font-weight: 600;
        }

        /* ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
        .results-table th:nth-child(3),
        .results-table td:nth-child(3) {
            border-right: 2px solid rgba(0,0,0,0.1);
        }
        .results-table th:nth-child(6),
        .results-table td:nth-child(6) {
            border-right: 2px solid rgba(0,0,0,0.1);
        }
        .results-table th:nth-child(9),
        .results-table td:nth-child(9) {
            border-right: 2px solid rgba(0,0,0,0.1);
        }
        .results-table th:nth-child(12),
        .results-table td:nth-child(12) {
            border-right: 2px solid rgba(0,0,0,0.1);
        }
        .results-table th:nth-child(15),
        .results-table td:nth-child(15) {
            border-right: 2px solid rgba(0,0,0,0.1);
        }

        h1 {
            text-align: left;
            color: #2B3674;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
        }

        .upload-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            max-width: 100%;
        }

        .upload-box {
            background: #F4F7FE;
            border: 1px solid #E9EDF7;
            border-radius: 8px;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .upload-box:hover {
            border-color: #4318FF;
            background: #FAFCFE;
        }

        .upload-box-title {
            font-size: 0.7em;
            font-weight: 500;
            color: #A3AED0;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
            min-width: auto;
        }

        .upload-box-number {
            background: #A3AED0;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65em;
            flex-shrink: 0;
        }

        .upload-area {
            border: 1px dashed #A3AED0;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 60px;
        }

        .upload-area:hover {
            border-color: #4318FF;
            background: #F4F7FE;
        }

        .upload-area.dragover {
            border-color: #4318FF;
            background: #EDE7FE;
        }

        .upload-area.has-file {
            border-color: #22C55E;
            border-style: solid;
            background: #F0FDF4;
        }

        .upload-icon {
            font-size: 12px;
        }

        .upload-text {
            font-size: 0.65em;
            color: #A3AED0;
        }

        .upload-hint {
            display: none;
        }

        .file-input {
            display: none;
        }

        .file-name {
            font-weight: 500;
            color: #22C55E;
            font-size: 0.65em;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-sheets {
            display: none;
        }

        .status-section {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
        }

        .status-text {
            font-size: 0.7em;
            color: #A3AED0;
        }

        .status-count {
            font-weight: 600;
            color: #4318FF;
        }

        .process-btn {
            background: linear-gradient(135deg, #4318FF 0%, #868CFF 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 5px 12px;
            cursor: pointer;
            font-size: 0.7em;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .process-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(67, 24, 255, 0.3);
        }

        .process-btn:disabled {
            background: #E9EDF7;
            color: #A3AED0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Mobile First - Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }
            
            h1 {
                font-size: 1.2em;
                text-align: center;
                margin-bottom: 10px;
            }
            
            /* ‡∏ã‡πà‡∏≠‡∏ô Upload Section ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            .upload-grid {
                display: none !important;
            }
            
            .results-section {
                padding: 10px;
                border-radius: 12px;
                margin-top: 0;
                overflow: visible;
                height: calc(100vh - 80px);
            }
            
            .results-title {
                font-size: 0.95em;
                text-align: center;
                flex-direction: column;
                gap: 3px;
                margin-bottom: 10px;
            }
            
            .results-table-container {
                max-height: calc(100vh - 130px);
                border-radius: 8px;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: none;
                overflow: auto;
            }
            
            /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ö‡∏ö Mobile-Friendly */
            .results-table {
                font-size: 0.75em;
                min-width: 700px;
            }
            
            .results-table th {
                padding: 10px 6px;
                font-size: 0.8em;
            }
            
            .results-table td {
                padding: 10px 6px;
            }
            
            .results-table th.sub-header {
                padding: 8px 5px;
                font-size: 0.75em;
            }
            
            .results-table td.left {
                font-weight: 600;
            }
            
            .no-data {
                padding: 30px;
                font-size: 1em;
            }
            
            /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô */
            .status-pending, .status-fifo {
                padding: 5px 8px;
                border-radius: 5px;
                font-size: 0.85em;
            }
        }
        
        /* Very small screens */
        @media (max-width: 400px) {
            .container {
                padding: 5px;
            }
            
            h1 {
                font-size: 1em;
                margin-bottom: 8px;
            }
            
            .results-section {
                padding: 8px;
                border-radius: 10px;
            }
            
            .results-title {
                font-size: 0.85em;
            }
            
            .results-table {
                font-size: 0.7em;
                min-width: 650px;
            }
            
            .results-table th {
                padding: 8px 4px;
            }
            
            .results-table td {
                padding: 8px 4px;
            }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .results-table tr:active {
                background: #E9EDF7;
            }
        }
        
        /* Landscape mode on mobile - ‡∏ã‡πà‡∏≠‡∏ô upload */
        @media (max-width: 900px) and (orientation: landscape) {
            .upload-grid {
                display: none !important;
            }
            
            .results-table-container {
                max-height: 70vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FIFO Real Time Dashboard</h1>
        
        <div class="upload-grid">
            <div class="upload-box">
                <div class="upload-box-title"><span class="upload-box-number">1</span> ‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô 0010</div>
                <div class="upload-area" id="dropZone0" data-index="0">
                    <span class="upload-icon">+</span>
                    <span class="upload-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
                </div>
                <input type="file" class="file-input" id="fileInput0" data-index="0" accept=".xlsx,.xls,.csv">
            </div>
            
            <div class="upload-box">
                <div class="upload-box-title"><span class="upload-box-number">2</span> ‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô 20</div>
                <div class="upload-area" id="dropZone1" data-index="1">
                    <span class="upload-icon">+</span>
                    <span class="upload-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
                </div>
                <input type="file" class="file-input" id="fileInput1" data-index="1" accept=".xlsx,.xls,.csv">
            </div>
            
            <div class="upload-box">
                <div class="upload-box-title"><span class="upload-box-number">3</span> ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ 0010</div>
                <div class="upload-area" id="dropZone2" data-index="2">
                    <span class="upload-icon">+</span>
                    <span class="upload-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
                </div>
                <input type="file" class="file-input" id="fileInput2" data-index="2" accept=".xlsx,.xls,.csv">
            </div>
            
            <div class="upload-box">
                <div class="upload-box-title"><span class="upload-box-number">4</span> ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ 20</div>
                <div class="upload-area" id="dropZone3" data-index="3">
                    <span class="upload-icon">+</span>
                    <span class="upload-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
                </div>
                <input type="file" class="file-input" id="fileInput3" data-index="3" accept=".xlsx,.xls,.csv">
            </div>
            
            <div class="upload-box">
                <div class="upload-box-title"><span class="upload-box-number">5</span> ‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢</div>
                <div class="upload-area" id="dropZone4" data-index="4">
                    <span class="upload-icon">+</span>
                    <span class="upload-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
                </div>
                <input type="file" class="file-input" id="fileInput4" data-index="4" accept=".xlsx,.xls,.csv">
            </div>
            
            <div class="status-section">
                <span class="status-text"><span class="status-count" id="uploadCount">0</span>/5</span>
                <button class="process-btn" id="processBtn" onclick="processData()">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</button>
            </div>
        </div>
        
        <!-- Results Section -->
        <div class="results-section">
            <div class="results-title" id="resultsTitle">‡∏Å‡∏≤‡∏£ FIFO ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
            <div class="results-table-container">
                <table class="results-table" cellspacing="0" cellpadding="0">
                    <colgroup>
                        <col style="width: 150px;">
                        <col style="width: 55px;">
                        <col style="width: 55px;">
                        <col style="width: 50px; min-width: 50px; max-width: 50px;">
                        <col style="width: 50px; min-width: 50px; max-width: 50px;">
                        <col style="width: 50px; min-width: 50px; max-width: 50px;">
                        <col style="width: 50px; min-width: 50px; max-width: 50px;">
                        <col style="width: 50px; min-width: 50px; max-width: 50px;">
                        <col style="width: 50px; min-width: 50px; max-width: 50px;">
                        <col style="width: 50px; min-width: 50px; max-width: 50px;">
                        <col style="width: 50px; min-width: 50px; max-width: 50px;">
                        <col style="width: 50px; min-width: 50px; max-width: 50px;">
                        <col style="width: 50px; min-width: 50px; max-width: 50px;">
                        <col style="width: 50px; min-width: 50px; max-width: 50px;">
                        <col style="width: 50px; min-width: 50px; max-width: 50px;">
                        <col style="width: auto;">
                        <col style="width: 70px;">
                    </colgroup>
                    <thead>
                        <tr>
                            <th rowspan="2">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th rowspan="2">‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á</th>
                            <th rowspan="2">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</th>
                            <th colspan="3" style="border-bottom: 2px solid rgba(255,255,255,0.3);">STOCK ‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô</th>
                            <th colspan="3" style="border-bottom: 2px solid rgba(255,255,255,0.3); background: linear-gradient(135deg, #059669 0%, #10B981 100%);">STOCK ‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô</th>
                            <th colspan="3" style="border-bottom: 2px solid rgba(255,255,255,0.3);">STOCK ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</th>
                            <th colspan="3" class="fifo-header" style="border-bottom: 2px solid rgba(255,255,255,0.3);">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏∏‡∏î‡∏à‡πà‡∏≤‡∏¢ FIFO</th>
                            <th rowspan="2">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</th>
                            <th rowspan="2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                        <tr>
                            <th class="sub-header">1 ‡∏ß‡∏±‡∏ô</th>
                            <th class="sub-header">2 ‡∏ß‡∏±‡∏ô</th>
                            <th class="sub-header">3 ‡∏ß‡∏±‡∏ô</th>
                            <th class="sub-header" style="background: #059669 !important;">1 ‡∏ß‡∏±‡∏ô</th>
                            <th class="sub-header" style="background: #059669 !important;">2 ‡∏ß‡∏±‡∏ô</th>
                            <th class="sub-header" style="background: #059669 !important;">3 ‡∏ß‡∏±‡∏ô</th>
                            <th class="sub-header">1 ‡∏ß‡∏±‡∏ô</th>
                            <th class="sub-header">2 ‡∏ß‡∏±‡∏ô</th>
                            <th class="sub-header">3 ‡∏ß‡∏±‡∏ô</th>
                            <th class="sub-header fifo-sub">1 ‡∏ß‡∏±‡∏ô</th>
                            <th class="sub-header fifo-sub">2 ‡∏ß‡∏±‡∏ô</th>
                            <th class="sub-header fifo-sub">3 ‡∏ß‡∏±‡∏ô</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <tr><td colspan="17" class="no-data">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•"</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Mas_SKU Data (hardcoded from Mas_SKU.xlsx)
        const MAS_SKU = [
            {warehouse: "10", code: "23015290", name: "‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ï‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å"},
            {warehouse: "10", code: "23045518", name: "‡∏°‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏ß ‡πÄ‡∏ö‡∏≠‡∏£‡πå 1"},
            {warehouse: "10", code: "23057677", name: "‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ôTT"},
            {warehouse: "10", code: "23015269", name: "‡πÄ‡∏®‡∏©‡∏ã‡∏µ‡πà‡πÇ‡∏Ñ‡∏£‡∏á"},
            {warehouse: "10", code: "23057702", name: "‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏≠‡∏ÅTT"},
            {warehouse: "10", code: "23057680", name: "‡∏Ç‡∏≤‡∏´‡∏•‡∏±‡∏áTT"},
            {warehouse: "10", code: "23000167", name: "‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏Ç‡∏≤‡πÄ‡∏•‡∏≤‡∏∞"},
            {warehouse: "10", code: "23057696", name: "‡πÄ‡∏®‡∏©‡∏°‡∏±‡∏ôTT"},
            {warehouse: "10", code: "23064091", name: "‡∏°‡∏±‡∏ô‡πÅ‡∏Ç‡πá‡∏á‡∏ï‡∏¥‡∏î‡∏´‡∏ô‡∏±‡∏á TT"},
            {warehouse: "10", code: "23000127", name: "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÑ‡∏´‡∏•‡πà‡∏ï‡∏¥‡∏î‡∏´‡∏ô‡∏±‡∏á"},
            {warehouse: "10", code: "23057672", name: "‡πÑ‡∏´‡∏•‡πàTT"},
            {warehouse: "10", code: "23063342", name: "‡πÑ‡∏´‡∏•‡πà‡∏ö‡∏îTT"},
            {warehouse: "10", code: "23065140", name: "‡∏™‡∏∞‡πÇ‡∏û‡∏Å‡∏™‡πÑ‡∏•‡∏î‡πå"},
            {warehouse: "10", code: "23069300", name: "‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏π‡∏ö‡∏îTT"},
            {warehouse: "10", code: "23057671", name: "‡∏Ñ‡∏≠‡∏´‡∏°‡∏π‡∏¢‡πà‡∏≤‡∏áTT"},
            {warehouse: "10", code: "23015265", name: "‡∏ã‡∏µ‡πà‡πÇ‡∏Ñ‡∏£‡∏á‡∏´‡∏±‡πà‡∏ô‡∏ä‡∏¥‡πâ‡∏ô"},
            {warehouse: "10", code: "23057700", name: "‡∏ã‡∏µ‡πà‡πÇ‡∏Ñ‡∏£‡∏áTT"},
            {warehouse: "10", code: "23057675", name: "‡∏™‡∏±‡∏ô‡πÉ‡∏ôTT"},
            {warehouse: "10", code: "23057676", name: "‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠TT"},
            {warehouse: "10", code: "23065142", name: "‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠‡∏™‡πÑ‡∏•‡∏î‡πå"},
            {warehouse: "10", code: "23057674", name: "‡∏™‡∏±‡∏ô‡∏ô‡∏≠‡∏ÅTT"},
            {warehouse: "10", code: "23065141", name: "‡∏™‡∏±‡∏ô‡∏ô‡∏≠‡∏Å‡∏™‡πÑ‡∏•‡∏î‡πå"},
            {warehouse: "10", code: "23096254", name: "‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ôTT(XL)"},
            {warehouse: "10", code: "23039556", name: "‡∏´‡∏°‡∏π‡∏ö‡∏î‡∏õ‡∏ô‡∏°‡∏±‡∏ô 30%"},
            {warehouse: "10", code: "23057698", name: "‡∏´‡∏°‡∏π‡∏ö‡∏îTT"},
            {warehouse: "10", code: "23000203", name: "‡∏ä‡∏¥‡πâ‡∏ô‡∏°‡∏±‡∏ô‡πÅ‡∏Ç‡πá‡∏á"},
            {warehouse: "10", code: "23000206", name: "‡∏ä‡∏¥‡πâ‡∏ô‡∏°‡∏±‡∏ô‡∏Ñ‡∏≠"},
            {warehouse: "10", code: "23057697", name: "‡∏ä‡∏¥‡πâ‡∏ô‡∏°‡∏±‡∏ô‡∏Ñ‡∏≠TT"},
            {warehouse: "10", code: "23067921", name: "‡πÄ‡∏®‡∏©‡∏°‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏´‡∏ô‡∏±‡∏áTT"},
            {warehouse: "10", code: "23063344", name: "‡πÄ‡∏®‡∏©‡∏´‡∏ô‡∏±‡∏áTT"},
            {warehouse: "10", code: "23057693", name: "‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡πÅ‡∏ß‡πà‡∏ôTT"},
            {warehouse: "10", code: "23057689", name: "‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏Ç‡πâ‡∏≠TT"},
            {warehouse: "10", code: "23057688", name: "‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏ã‡∏∏‡∏õTT"},
            {warehouse: "10", code: "23057690", name: "‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏≠‡πà‡∏≠‡∏ôTT"},
            {warehouse: "10", code: "23000168", name: "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡πÄ‡∏•‡∏≤‡∏∞"},
            {warehouse: "10", code: "23057679", name: "‡∏Ç‡∏≤‡∏´‡∏ô‡πâ‡∏≤TT"},
            {warehouse: "10", code: "23063196", name: "‡∏Ç‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ú‡∏≤TT"},
            {warehouse: "10", code: "23019173", name: "‡∏Ç‡∏≤‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ú‡∏≤‡πÅ‡∏ö‡πà‡∏á‡∏Ñ‡∏≤‡∏Å‡∏¥"},
            {warehouse: "10", code: "23063197", name: "‡∏Ç‡∏≤‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ú‡∏≤TT"},
            {warehouse: "10", code: "23014036", name: "‡∏Ñ‡∏≤‡∏Å‡∏¥‡πÄ‡∏ú‡∏≤"},
            {warehouse: "10", code: "23015313", name: "‡∏Ñ‡∏≤‡∏Å‡∏¥"},
            {warehouse: "10", code: "23057691", name: "‡∏°‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏ßTT"},
            {warehouse: "10", code: "23057685", name: "‡∏°‡∏±‡∏ô‡πÅ‡∏Ç‡πá‡∏áTT"},
            {warehouse: "10", code: "23057695", name: "‡∏°‡∏±‡∏ô‡∏ó‡πâ‡∏≠‡∏áTT"},
            {warehouse: "10", code: "23057684", name: "‡∏°‡∏±‡∏ô‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏áTT"},
            {warehouse: "10", code: "23000172", name: "‡∏•‡∏¥‡πâ‡∏ô‡∏´‡∏°‡∏π"},
            {warehouse: "10", code: "23057687", name: "‡∏´‡∏ô‡∏±‡∏á‡∏´‡∏°‡∏π‡∏£‡∏ß‡∏°TT"},
            {warehouse: "10", code: "23071823", name: "‡∏´‡∏ô‡∏±‡∏á‡∏Ç‡∏≤‡∏´‡∏°‡∏π"},
            {warehouse: "10", code: "23015378", name: "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∞‡πÇ‡∏û‡∏Å‡∏ï‡∏¥‡∏î‡∏°‡∏±‡∏ô"},
            {warehouse: "10", code: "23057681", name: "‡∏´‡∏≤‡∏á‡∏´‡∏°‡∏πTT"},
            {warehouse: "10", code: "23000175", name: "‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡∏´‡∏°‡∏π"},
            {warehouse: "10", code: "23105854", name: "‡πÑ‡∏´‡∏•‡πà‡∏´‡∏°‡∏π B2B (Basic)"},
            {warehouse: "10", code: "23105855", name: "‡∏™‡∏∞‡πÇ‡∏û‡∏Å‡∏´‡∏°‡∏π B2B (Basic)"},
            {warehouse: "10", code: "23105856", name: "‡∏™‡∏±‡∏ô‡∏ô‡∏≠‡∏Å‡∏´‡∏°‡∏π B2B (Basic)"},
            {warehouse: "20", code: "23000194", name: "‡πÑ‡∏ï"},
            {warehouse: "20", code: "23000192", name: "‡πÑ‡∏™‡πâ‡πÉ‡∏´‡∏ç‡πà(‡∏•‡∏ß‡∏Å)"},
            {warehouse: "20", code: "23015350", name: "‡πÑ‡∏™‡πâ‡πÉ‡∏´‡∏ç‡πà"},
            {warehouse: "20", code: "23000181", name: "‡πÑ‡∏™‡πâ‡∏Ç‡∏°"},
            {warehouse: "20", code: "23014042", name: "‡πÑ‡∏™‡πâ‡∏ï‡∏±‡∏ô‡∏•‡∏ß‡∏Å"},
            {warehouse: "20", code: "23015346", name: "‡πÑ‡∏™‡πâ‡∏ï‡∏±‡∏ô"},
            {warehouse: "20", code: "23000191", name: "‡πÑ‡∏™‡πâ‡∏≠‡πà‡∏≠‡∏ô"},
            {warehouse: "20", code: "23000189", name: "‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏≤‡∏∞"},
            {warehouse: "20", code: "23015342", name: "‡∏Å‡∏£‡∏∞‡πÄ‡∏û‡∏≤‡∏∞‡∏•‡∏ß‡∏Å"},
            {warehouse: "20", code: "23000186", name: "‡∏Ç‡∏±‡πâ‡∏ß‡∏ï‡∏±‡∏ö"},
            {warehouse: "20", code: "23000188", name: "‡∏ï‡∏±‡∏ö‡∏´‡∏°‡∏π"},
            {warehouse: "20", code: "23000187", name: "‡∏õ‡∏≠‡∏î"},
            {warehouse: "20", code: "23000193", name: "‡∏°‡πâ‡∏≤‡∏°"},
            {warehouse: "20", code: "23000190", name: "‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏´‡∏°‡∏π"},
            {warehouse: "20", code: "23015321", name: "‡∏´‡∏±‡∏ß‡∏ï‡∏¥‡∏î‡∏•‡∏¥‡πâ‡∏ô"}
        ];

        const MAX_FILES = 5;
        let uploadedFiles = new Array(MAX_FILES).fill(null); // Array of { name, workbook } or null

        const uploadCount = document.getElementById('uploadCount');

        // Initialize all upload areas
        for (let i = 0; i < MAX_FILES; i++) {
            const dropZone = document.getElementById(`dropZone${i}`);
            const fileInput = document.getElementById(`fileInput${i}`);

            // Click to upload
            dropZone.addEventListener('click', (e) => {
                fileInput.click();
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0], i);
                    fileInput.value = '';
                }
            });

            // Drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0], i);
                }
            });
        }

        function handleFile(file, index) {
            const extension = file.name.split('.').pop().toLowerCase();
            if (!['xlsx', 'xls', 'csv'].includes(extension)) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx, .xls) ‡∏´‡∏£‡∏∑‡∏≠ CSV ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    let workbook;
                    
                    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV ‡πÉ‡∏ä‡πâ encoding TIS-620 (cp874) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
                    if (extension === 'csv') {
                        const decoder = new TextDecoder('windows-874');
                        const text = decoder.decode(new Uint8Array(e.target.result));
                        workbook = XLSX.read(text, { type: 'string' });
                    } else {
                        const data = new Uint8Array(e.target.result);
                        workbook = XLSX.read(data, { type: 'array' });
                    }
                    
                    uploadedFiles[index] = {
                        name: file.name,
                        workbook: workbook
                    };
                    
                    renderUploadArea(index);
                    updateCount();
                    
                    // Re-enable process button when new file is uploaded
                    document.getElementById('processBtn').disabled = false;
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function renderUploadArea(index) {
            const dropZone = document.getElementById(`dropZone${index}`);
            const file = uploadedFiles[index];

            if (file) {
                dropZone.classList.add('has-file');
                // Show short filename (max 10 chars)
                const shortName = file.name.length > 12 ? file.name.substring(0, 10) + '...' : file.name;
                dropZone.innerHTML = `
                    <span class="upload-icon">‚úì</span>
                    <span class="file-name" title="${escapeHtml(file.name)}">${escapeHtml(shortName)}</span>
                `;
            } else {
                dropZone.classList.remove('has-file');
                dropZone.innerHTML = `
                    <span class="upload-icon">+</span>
                    <span class="upload-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
                `;
            }
        }

        function updateCount() {
            const count = uploadedFiles.filter(f => f !== null).length;
            uploadCount.textContent = count;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Process data and do lookup
        function processData() {
            const file0 = uploadedFiles[0]; // STOCK ‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô 0010
            const file1 = uploadedFiles[1]; // STOCK ‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô 20
            const file2 = uploadedFiles[2]; // STOCK ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ 0010
            const file3 = uploadedFiles[3]; // STOCK ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ 20
            const file4 = uploadedFiles[4]; // ‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            
            if (!file0 && !file1 && !file2 && !file3) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÑ‡∏ü‡∏•‡πå');
                return;
            }

            try {
                // Build stock maps
                const stockMapStart10 = file0 ? processStockFile(file0) : {};
                const stockMapStart20 = file1 ? processStockFile(file1) : {};
                const stockMapNow10 = file2 ? processStockFile(file2) : {};
                const stockMapNow20 = file3 ? processStockFile(file3) : {};
                const dispatchData = file4 ? processDispatchFile(file4) : { dispatchMap: {}, orderMap: {}, truckMap: {} };
                const dispatchMap = dispatchData.dispatchMap;
                const orderMap = dispatchData.orderMap;
                const truckMap = dispatchData.truckMap;
                
                const allResults = [];
                
                // Process warehouse 10
                const results10 = getResultsForWarehouse(stockMapStart10, stockMapNow10, dispatchMap, orderMap, truckMap, "10");
                allResults.push(...results10);
                
                // Process warehouse 20
                const results20 = getResultsForWarehouse(stockMapStart20, stockMapNow20, dispatchMap, orderMap, truckMap, "20");
                allResults.push(...results20);
                
                // Render combined results
                renderResults(allResults);
                
                // Save to Firebase
                saveToFirebase(allResults);
                
                // Update title with date/time
                const now = new Date();
                const dateStr = now.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const timeStr = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('resultsTitle').textContent = `‡∏Å‡∏≤‡∏£ FIFO ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó ${dateStr} ${timeStr}`;
                
                // Disable button after processing
                document.getElementById('processBtn').disabled = true;
                
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•: ' + error.message);
                console.error(error);
            }
        }
        
        function processStockFile(file) {
            const workbook = file.workbook;
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            
            // Convert sheet to array (include headers)
            const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            // Column indices for weight data (based on analysis):
            // Col 9: ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (1-1 ‡∏ß‡∏±‡∏ô)
            // Col 12: ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (2-2 ‡∏ß‡∏±‡∏ô)
            // Col 15: ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (3-3 ‡∏ß‡∏±‡∏ô)
            // Col 18: ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (> 3 ‡∏ß‡∏±‡∏ô)
            // Col 20: ‡∏£‡∏´‡∏±‡∏™ SAP (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î 0 ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ 10 ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏≠‡∏≠‡∏Å)
            
            const WEIGHT_COLS = {
                day1: 9,
                day2: 12,
                day3: 15,
                moreThan3: 18
            };
            const SAP_COL = 20; // ‡∏£‡∏´‡∏±‡∏™ SAP
            const NAME_COL = 1; // ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            const WAREHOUSE_COL = 22; // Column W (index 22) = ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/Plant
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå warehouse 20 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå)
            const isWarehouse20 = file.name.includes('20');
            
            // Build lookup map from file data (skip first 2 header rows)
            const stockMap = {};
            const skippedRows = [];
            let processedCount = 0;
            
            for (let i = 2; i < rawData.length; i++) {
                const row = rawData[i];
                if (!row || !row[SAP_COL]) continue;
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå warehouse 20 ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ row ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå W = "20"
                if (isWarehouse20 && row[WAREHOUSE_COL]) {
                    const warehouseValue = String(row[WAREHOUSE_COL]).trim();
                    const warehouseNum = parseFloat(warehouseValue);
                    
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô "20" (string) ‡∏´‡∏£‡∏∑‡∏≠ 20 (number) ‡∏´‡∏£‡∏∑‡∏≠ 20.0
                    if (warehouseValue !== "20" && warehouseNum !== 20) {
                        skippedRows.push({
                            row: i,
                            warehouse: warehouseValue,
                            product: row[NAME_COL] ? String(row[NAME_COL]) : ''
                        });
                        continue; // ‡∏Ç‡πâ‡∏≤‡∏° row ‡∏ô‡∏µ‡πâ
                    }
                }
                
                // ‡∏£‡∏´‡∏±‡∏™ SAP ‡πÄ‡∏ä‡πà‡∏ô "000000000023034408" ‡∏ï‡∏±‡∏î 10 ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏≠‡∏≠‡∏Å -> "23034408"
                const sapCode = String(row[SAP_COL]).trim();
                const skuCode = sapCode.length > 10 ? sapCode.substring(10) : sapCode;
                const productName = row[NAME_COL] ? String(row[NAME_COL]) : '';
                
                const day1 = parseFloat(row[WEIGHT_COLS.day1]) || 0;
                const day2 = parseFloat(row[WEIGHT_COLS.day2]) || 0;
                const day3 = parseFloat(row[WEIGHT_COLS.day3]) || 0;
                const moreThan3 = parseFloat(row[WEIGHT_COLS.moreThan3]) || 0;
                
                // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ row ‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏ö (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)
                if (!stockMap[skuCode]) {
                    stockMap[skuCode] = {
                        day1: day1,
                        day2: day2,
                        day3: day3,
                        moreThan3: moreThan3,
                        productName: productName
                    };
                }
                processedCount++;
            }
            
            // Log file info
            console.log('üìä STOCK File:', file.name);
            console.log('   - Processed rows:', processedCount);
            console.log('   - Unique SKU codes:', Object.keys(stockMap).length);
            
            // Log skipped rows (for warehouse 20 files)
            if (isWarehouse20 && skippedRows.length > 0) {
                console.log(`‚è≠Ô∏è Skipped ${skippedRows.length} rows (warehouse ‚â† 20):`);
                skippedRows.slice(0, 5).forEach(item => {
                    console.log(`   Row ${item.row}: Warehouse="${item.warehouse}" - ${item.product}`);
                });
                if (skippedRows.length > 5) {
                    console.log(`   ... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${skippedRows.length - 5} rows`);
                }
            }
            
            // Log warehouse 20 codes if present
            const wh20Codes = ['23000194', '23000192', '23015350', '23000181', '23014042', '23015346', 
                               '23000191', '23000189', '23015342', '23000186', '23000188', '23000187', 
                               '23000193', '23000190', '23015321'];
            const foundWh20 = wh20Codes.filter(code => stockMap[code]);
            if (foundWh20.length > 0) {
                console.log('‚úÖ Warehouse 20 codes found:', foundWh20.length, '/', wh20Codes.length);
                foundWh20.slice(0, 5).forEach(code => {
                    const data = stockMap[code];
                    const totalWeight = data.day1 + data.day2 + data.day3 + data.moreThan3;
                    console.log(`   ${code}: ${data.productName} (‡∏£‡∏ß‡∏° ${totalWeight.toFixed(2)} kg)`);
                });
            }
            
            return stockMap;
        }
        
        // Process dispatch file (‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ CSV)
        function processDispatchFile(file) {
            const workbook = file.workbook;
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            
            // Convert sheet to array
            const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            // CSV ‡∏°‡∏µ row ‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó, row ‡∏ó‡∏µ‡πà 2 ‡πÄ‡∏õ‡πá‡∏ô header
            // Column U (index 20) = rProduct_code = ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            // Column X (index 23) = rStock_wgt = ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á
            // Column AD (index 29) = rAllocate_stock_wgt = ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢
            // Column BN (index 65) = ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡∏Ç‡∏ô‡∏™‡πà‡∏á
            const PRODUCT_CODE_COL = 20;
            const ORDER_QTY_COL = 23; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå X = ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á
            const DISPATCH_QTY_COL = 29;
            const TRUCK_PLATE_COL = 65;
            
            const dispatchMap = {};
            const orderMap = {}; // SKU -> ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå X)
            const truckMap = {}; // SKU -> array of truck plates (where AD=0)
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å row 2 (skip header rows)
            for (let i = 2; i < rawData.length; i++) {
                const row = rawData[i];
                if (!row || !row[PRODUCT_CODE_COL]) continue;
                
                const productCode = String(row[PRODUCT_CODE_COL]).trim();
                const orderQty = parseFloat(row[ORDER_QTY_COL]) || 0;
                const dispatchQty = parseFloat(row[DISPATCH_QTY_COL]) || 0;
                // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ
                const rawTruckPlate = row[TRUCK_PLATE_COL] ? String(row[TRUCK_PLATE_COL]).trim() : '';
                const truckPlate = rawTruckPlate.replace(/[^0-9]/g, '');
                
                // ‡∏™‡∏∞‡∏™‡∏°‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢ row ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                if (orderMap[productCode]) {
                    orderMap[productCode] += orderQty;
                } else {
                    orderMap[productCode] = orderQty;
                }
                
                // ‡∏™‡∏∞‡∏™‡∏°‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢ row ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                if (dispatchMap[productCode]) {
                    dispatchMap[productCode] += dispatchQty;
                } else {
                    dispatchMap[productCode] = dispatchQty;
                }
                
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà AD=0 (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á)
                if (dispatchQty === 0 && truckPlate) {
                    if (!truckMap[productCode]) {
                        truckMap[productCode] = new Set();
                    }
                    truckMap[productCode].add(truckPlate);
                }
            }
            
            // Convert Sets to Arrays
            const truckMapArray = {};
            for (const code in truckMap) {
                truckMapArray[code] = Array.from(truckMap[code]);
            }
            
            console.log('Order Map:', Object.keys(orderMap).length, 'products');
            console.log('Dispatch Map:', Object.keys(dispatchMap).length, 'products');
            console.log('Truck Map:', Object.keys(truckMapArray).length, 'products with pending trucks');
            return { dispatchMap, orderMap, truckMap: truckMapArray };
        }
        
        function getResultsForWarehouse(stockMapStart, stockMapNow, dispatchMap, orderMap, truckMap, warehouseFilter) {
            const filteredSKU = MAS_SKU.filter(item => item.warehouse === warehouseFilter);
            const results = [];
            
            filteredSKU.forEach((item) => {
                const startData = stockMapStart[item.code];
                const nowData = stockMapNow[item.code];
                const dispatchQty = dispatchMap[item.code] || null;
                const orderQty = orderMap[item.code] || null;
                const trucks = truckMap[item.code] || [];
                results.push({
                    warehouse: item.warehouse,
                    code: item.code,
                    name: item.name,
                    // STOCK ‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô
                    startDay1: startData ? startData.day1 : null,
                    startDay2: startData ? startData.day2 : null,
                    startDay3: startData ? startData.day3 : null,
                    startMoreThan3: startData ? startData.moreThan3 : null,
                    // STOCK ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                    nowDay1: nowData ? nowData.day1 : null,
                    nowDay2: nowData ? nowData.day2 : null,
                    nowDay3: nowData ? nowData.day3 : null,
                    nowMoreThan3: nowData ? nowData.moreThan3 : null,
                    // ‡∏¢‡∏≠‡∏î‡∏™‡∏±‡πà‡∏á (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå X)
                    order: orderQty,
                    // ‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢
                    dispatch: dispatchQty,
                    // ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ (AD=0)
                    trucks: trucks,
                    foundStart: !!startData,
                    foundNow: !!nowData,
                    foundDispatch: dispatchQty !== null
                });
            });
            
            return results;
        }

        function renderResults(results) {
            const tbody = document.getElementById('resultsTableBody');
            const formatVal = (val) => (val !== null && !isNaN(val)) ? Math.floor(val) : '-';
            
            const calcDiff = (now, expected) => {
                const nowVal = (now !== null && !isNaN(now)) ? now : 0;
                const expVal = (expected !== null && !isNaN(expected)) ? expected : 0;
                const diff = nowVal - expVal;
                return diff < 0 ? 0 : Math.floor(diff);
            };
            
            // Process all items and calculate FIFO data
            const processedItems = [];
            
            results.forEach((item) => {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (FIFO - ‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô)
                let remaining = {
                    day1: item.startDay1 !== null ? item.startDay1 : 0,
                    day2: item.startDay2 !== null ? item.startDay2 : 0,
                    day3: item.startDay3 !== null ? item.startDay3 : 0,
                    moreThan3: item.startMoreThan3 !== null ? item.startMoreThan3 : 0
                };
                
                let dispatchLeft = item.dispatch !== null ? item.dispatch : 0;
                
                // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å >3‡∏ß‡∏±‡∏ô ‡∏Å‡πà‡∏≠‡∏ô
                if (dispatchLeft > 0 && remaining.moreThan3 > 0) {
                    const deduct = Math.min(dispatchLeft, remaining.moreThan3);
                    remaining.moreThan3 -= deduct;
                    dispatchLeft -= deduct;
                }
                // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å 3‡∏ß‡∏±‡∏ô
                if (dispatchLeft > 0 && remaining.day3 > 0) {
                    const deduct = Math.min(dispatchLeft, remaining.day3);
                    remaining.day3 -= deduct;
                    dispatchLeft -= deduct;
                }
                // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å 2‡∏ß‡∏±‡∏ô
                if (dispatchLeft > 0 && remaining.day2 > 0) {
                    const deduct = Math.min(dispatchLeft, remaining.day2);
                    remaining.day2 -= deduct;
                    dispatchLeft -= deduct;
                }
                // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å 1‡∏ß‡∏±‡∏ô
                if (dispatchLeft > 0 && remaining.day1 > 0) {
                    const deduct = Math.min(dispatchLeft, remaining.day1);
                    remaining.day1 -= deduct;
                    dispatchLeft -= deduct;
                }
                
                const hasStartData = item.startDay1 !== null || item.startDay2 !== null || item.startDay3 !== null || item.startMoreThan3 !== null;
                const hasNowData = item.nowDay1 !== null || item.nowDay2 !== null || item.nowDay3 !== null || item.nowMoreThan3 !== null;
                
                const diffDay1 = calcDiff(item.nowDay1, remaining.day1);
                const diffDay2 = calcDiff(item.nowDay2, remaining.day2);
                const diffDay3 = calcDiff(item.nowDay3, remaining.day3);
                const diffMoreThan3 = calcDiff(item.nowMoreThan3, remaining.moreThan3);
                const canShowDiff = hasStartData && hasNowData;
                
                const hasNonZeroDiff = diffDay1 > 0 || diffDay2 > 0 || diffDay3 > 0 || diffMoreThan3 > 0;
                if (!canShowDiff || !hasNonZeroDiff) return;
                
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á
                if (!item.dispatch || item.dispatch === 0) return;
                
                const hasTrucks = item.trucks && item.trucks.length > 0;
                const totalDiff = diffDay1 + diffDay2 + diffDay3 + diffMoreThan3;
                
                processedItems.push({
                    ...item,
                    diffDay1, diffDay2, diffDay3, diffMoreThan3,
                    totalDiff,
                    hasTrucks,
                    trucksDisplay: hasTrucks ? item.trucks.join(', ') : '-',
                    // STOCK ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô (remaining)
                    expectedDay1: remaining.day1,
                    expectedDay2: remaining.day2,
                    expectedDay3: remaining.day3
                });
            });
            
            // Sort: ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢ first, then by total FIFO diff descending
            processedItems.sort((a, b) => {
                // ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢ (hasTrucks=true) comes first
                if (a.hasTrucks !== b.hasTrucks) {
                    return a.hasTrucks ? -1 : 1;
                }
                // Then sort by total FIFO diff descending
                return b.totalDiff - a.totalDiff;
            });
            
            // Render sorted items
            let html = '';
            processedItems.forEach((item) => {
                const statusClass = item.hasTrucks ? 'status-pending' : 'status-fifo';
                const statusText = item.hasTrucks ? '‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢' : '‡∏´‡∏•‡∏∏‡∏î FIFO';
                
                html += `<tr>
                    <td class="left">${escapeHtml(item.name)}</td>
                    <td>${formatVal(item.order)}</td>
                    <td>${formatVal(item.dispatch)}</td>
                    <td>${formatVal(item.startDay1)}</td>
                    <td>${formatVal(item.startDay2)}</td>
                    <td>${formatVal(item.startDay3)}</td>
                    <td>${formatVal(item.expectedDay1)}</td>
                    <td>${formatVal(item.expectedDay2)}</td>
                    <td>${formatVal(item.expectedDay3)}</td>
                    <td>${formatVal(item.nowDay1)}</td>
                    <td>${formatVal(item.nowDay2)}</td>
                    <td>${formatVal(item.nowDay3)}</td>
                    <td class="${item.diffDay1 > 0 ? 'fifo-alert' : ''}">${item.diffDay1}</td>
                    <td class="${item.diffDay2 > 0 ? 'fifo-alert' : ''}">${item.diffDay2}</td>
                    <td class="${item.diffDay3 > 0 ? 'fifo-alert' : ''}">${item.diffDay3}</td>
                    <td class="left">${escapeHtml(item.trucksDisplay)}</td>
                    <td class="${statusClass}">${statusText}</td>
                </tr>`;
            });
            
            if (processedItems.length === 0) {
                html = '<tr><td colspan="17" class="no-data">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏∏‡∏î‡∏à‡πà‡∏≤‡∏¢ FIFO</td></tr>';
            }
            
            tbody.innerHTML = html;
            console.log(`Rendered ${processedItems.length} SKUs with FIFO issues`);
        }

        // ==================== Firebase Integration ====================
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDx9JzoWr1miSAIJN1fPSlM4JbXrixiphk",
            authDomain: "fifo-dashboard.firebaseapp.com",
            databaseURL: "https://fifo-dashboard-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "fifo-dashboard",
            storageBucket: "fifo-dashboard.firebasestorage.app",
            messagingSenderId: "859148676840",
            appId: "1:859148676840:web:3aaea2c105eea84128635d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Save data to Firebase
        function saveToFirebase(results) {
            const now = new Date();
            const dataToSave = {
                updatedAt: now.toISOString(),
                updatedAtThai: now.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
                results: results
            };
            
            database.ref('fifo-data').set(dataToSave)
                .then(() => {
                    console.log('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                })
                .catch((error) => {
                    console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:', error);
                });
        }

        // Load data from Firebase (for mobile/real-time sync)
        function loadFromFirebase() {
            database.ref('fifo-data').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.results) {
                    console.log('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase:', data.updatedAtThai);
                    renderResults(data.results);
                    document.getElementById('resultsTitle').textContent = `‡∏Å‡∏≤‡∏£ FIFO ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó ${data.updatedAtThai}`;
                }
            });
        }

        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô bounce ‡∏ö‡∏ô iOS Safari ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÉ‡∏´‡πâ scroll ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏î‡πâ
        let startY = 0;
        
        document.addEventListener('touchstart', function(e) {
            startY = e.touches[0].clientY;
        }, { passive: true });
        
        document.addEventListener('touchmove', function(e) {
            // ‡∏´‡∏≤ scrollable parent
            let target = e.target;
            let isInScrollable = false;
            
            while (target && target !== document.body) {
                if (target.classList) {
                    if (target.classList.contains('results-table-container') ||
                        target.classList.contains('container')) {
                        
                        const scrollTop = target.scrollTop;
                        const scrollHeight = target.scrollHeight;
                        const clientHeight = target.clientHeight;
                        const deltaY = startY - e.touches[0].clientY;
                        
                        // ‡∏ñ‡πâ‡∏≤ scroll ‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Ç‡∏≠‡∏ö) ‡πÉ‡∏´‡πâ scroll ‡∏õ‡∏Å‡∏ï‡∏¥
                        if ((deltaY > 0 && scrollTop < scrollHeight - clientHeight) ||
                            (deltaY < 0 && scrollTop > 0)) {
                            isInScrollable = true;
                        }
                        break;
                    }
                }
                target = target.parentNode;
            }
            
            if (!isInScrollable) {
                e.preventDefault();
            }
        }, { passive: false });

        // Start listening for Firebase updates on page load
        loadFromFirebase();
    </script>
</body>
</html>
